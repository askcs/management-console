define(["services/services"],function(e){e.factory("Store",["$window","$parse",function(e,t){var n={},r=[];return function(i,s){var o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;return c=function(e){try{return h(e)}catch(t){return null}},o=function(e){return new Lawnchair({name:i},e)},v=function(t,r){var i;r=r.toString(),angular.isObject(t)&&t!==n[r]?(n[r]=n[r]||{},angular.extend(n[r],t)):n[r]=t,i={key:r,value:g(n[r])};try{o(function(){this.save(i)})}catch(s){(s.name==="QUOTA_EXCEEDED_ERR"||s.name==="NS_ERROR_DOM_QUOTA_REACHED")&&e.localStorage.clear()}},y=function(e){return r.length=0,_.each(e,function(e){r.push(e)}),r},b=function(e,t){e&&angular.isObject(e)&&n[t]&&n[t]!==e?angular.extend(n[t],e):n[t]=e},w=function(e,t){return t&&(angular.isObject(t.value)&&angular.isObject(e)?angular.extend(e,m(t.value)):e=m(t.value),b(e,t.key)),e},f=function(e){return o(function(){this.all(function(t){_.each(t,function(e){b(e.value,e.key)}),e&&e(n)})}),n},a=function(e){return y(f(function(t){y(t),e&&e(r)}))},d=function(e){delete n[e],o(function(){this.remove(e)})},l=function(e){return n[e]?n[e]:null},p=s&&s.isArray,h=t(s&&s.entryKey?s.entryKey:"id"),g=s&&s.transformSave?s.transformSave:angular.identity,m=s&&s.transformLoad?s.transformLoad:angular.identity,u={collection:n,save:function(e,t,r){var i;t||(t=n,e=null),e&&v(t,e||c(t)),r&&(i=angular.isArray(t)?_.chain(t).map(c).map(String).value():_.keys(t),_.chain(n).keys().difference(i).each(d),_.chain(n).filter(function(e){return!c(e)}).keys().each(d))},batch:function(e,t,n){var r;return r=_.chain(e).map(function(e){return l(e)}).value(),t&&angular.isArray(t)?(t.length=0,_.each(r,function(e){t.push(e)})):t=r,o(function(){this.get(e,function(e){var r;if(e){r=e.length-1;while(r>=0)t[r]=w(t[r],e[r]),r--}n&&n(t)})}),t},has:function(e,t){o(function(){this.exists(e,function(e){t(e)})})},get:function(e,t){var n;return n=l(e),o(function(){this.get(e,function(e){e&&(n=w(n,e)),n!==null&&n.hasOwnProperty("0")&&typeof n!="string"&&(n=_.map(n,function(e){return e})),t&&t(n)})}),n},nuke:function(){o(function(){this.nuke()})},all:p?a:f,remove:d,destroy:function(){var e;for(e in n)delete n[e];o(function(){this.nuke()})}},u}}])});